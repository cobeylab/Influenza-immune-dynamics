demog_data = demography
sero_data = serology
resolution = "year"
attack_rate = 0.28/12
duration_mat_Abs = duration_maternal_Abs
n_yrs =12
MONTHS_PER_YEAR = 12
id = unique(serology$memberID)[1]
id
demog <- demog_data %>% filter(memberID == id)
sero <- sero_data %>% filter(memberID == id)
sero
head(serology)
head(demography)
db <- dbConnect(SQLite(), dbFilename)
serology <- dbReadTable(db, "serology_full_model") %>%
filter(subtype == test_subtype) %>%
mutate(date = as.Date(date, origin = "1970-1-1"))
demography <- dbReadTable(db, "demography_full_model") %>%
mutate(birthdate = as.Date(birthdate, origin = "1970-1-1"),
visitdate = as.Date(visitdate, origin = "1970-1-1"))
L_data <- dbReadTable(db, community_intensity_table_name)
dbDisconnect(db)
demog_data = demography
sero_data = serology
id = 2
demog <- demog_data %>% filter(memberID == id)
sero <- sero_data %>% filter(memberID == id)
demog
first_vis_date <- min(sero$date)
first_vis_month <- month(first_vis_date)
first_vis_year <- year(first_vis_date)
first_vis_date
first_vis_month
first_vis_year
birthdate <- as.Date(demog$birthdate,origin = '1970-1-1') %m+% months(duration_mat_Abs)
birthyear <- year(birthdate)
birthmonth <- month(birthdate)
p_uninfected = p_uninfected_init
df_exposure <- expand.grid(year = c(birthyear:(birthyear + (n_yrs+1))), month = c(1:12)) %>% arrange(year)
df_exposure$p_infected = NA
df_exposure$p_naive = NA
head(df_exposure)
# Make sure that the exposure only accounts for time after birth and before first visit
df_exposure <- df_exposure %>% filter(!(year <=birthyear & month<=birthmonth))
dim(df_exposure)
df_exposure <- expand.grid(year = c(birthyear:(birthyear + (n_yrs+1))), month = c(1:12)) %>% arrange(year)
dim(df_exposure)
first_vis_year
first_vis_month
df_exposure <- df_exposure %>%
filter(!(year <=birthyear & month<=birthmonth)) %>%
filter(year < first_vis_year & month < first_vis_month)
dim(df_exposure)
View(df_exposure)
df_exposure <- expand.grid(year = c(birthyear:(birthyear + (n_yrs+1))), month = c(1:12)) %>% arrange(year)
df_exposure$p_infected = NA
df_exposure$p_naive = NA
# Make sure that the exposure only starts after birth and that (for kids < 12yo) exposure doesn't overlap visit dates
df_exposure <- df_exposure %>%
filter(!(year <=birthyear & month<=birthmonth)) %>%
filter(!(year >= first_vis_year & month >= first_vis_month))
dim(df_exposure)
if(nrow(df_exposure) > n_yrs*MONTHS_PER_YEAR){
df_exposure <- df_exposure[1:(n_yrs*MONTHS_PER_YEAR),]
}
df_exposure[1,]$p_infected <- prob_primary_flu_next_dt(p_uninfected = p_uninfected_init)["p_first_infection"]
df_exposure[1,]$p_naive <-  prob_primary_flu_next_dt(p_uninfected = p_uninfected_init)["p_naive"]
for(y in c(2:nrow(df_exposure))){
df <- prob_primary_flu_next_dt(p_uninfected = unlist(df_exposure[y-1,]$p_naive))
df_exposure[y,]$p_infected <- unlist(df["p_first_infection"])
df_exposure[y,]$p_naive <- unlist(df["p_naive"])
}
df_exposure <- as.data.frame(apply(df_exposure,2,unlist))
df_exposure["h1n1"] = 0
df_exposure["h3n2"] = 0
df_exposure["h2n2"] = 0
strain_vec
for(s in c(1:length(strain_vec))){
strain = strain_vec[s]
for(y in c(1:nrow(df_exposure))){
if(resolution == "month"){
strain_data <- incidence_data %>% filter(year == df_exposure[y,]$year & month == df_exposure[y,]$month)
}
if(resolution == "year"){
strain_data <- incidence_data %>% filter(year == df_exposure[y,]$year)
}
p_inf_this_strain <- as.numeric(strain_data %>% select(contains(strain)))*df_exposure[y,]$p_infected
df_exposure[y,which(names(df_exposure)==strain)] <- p_inf_this_strain
}
}
cum_probs <- apply(df_exposure[, names(df_exposure) %in% strain_vec ],2,sum)
## Scaling
if(nrow(df_exposure) == (n_yrs*MONTHS_PER_YEAR)){
strain_probs <- cum_probs/sum(cum_probs)
strain_probs["p_naive"] <- 0
}
if(nrow(df_exposure) < (n_yrs*MONTHS_PER_YEAR)){
p_naive <- df_exposure[nrow(df_exposure),]$p_naive
strain_probs <- (cum_probs*(1 - p_naive))/sum(cum_probs)
strain_probs["p_naive"] <- p_naive
}
strain_probs
imprinting_data <- lapply(unique(serology$memberID), prob_primary_exposure, demog_data = demography, sero_data = serology)
length(unique(serology$memberID))
id = 4
sero <- sero_data %>% filter(memberID == id)
first_vis_date <- min(sero$date)
first_vis_month <- month(first_vis_date)
first_vis_year <- year(first_vis_date)
birthdate <- as.Date(demog$birthdate,origin = '1970-1-1') %m+% months(duration_mat_Abs)
birthyear <- year(birthdate)
birthmonth <- month(birthdate)
p_uninfected = p_uninfected_init
df_exposure <- expand.grid(year = c(birthyear:(birthyear + (n_yrs+1))), month = c(1:12)) %>% arrange(year)
sero
df_exposure$p_infected = NA
df_exposure$p_naive = NA
# Make sure that the exposure only starts after birth and that (for kids < 12yo) exposure doesn't overlap visit dates
df_exposure <- df_exposure %>%
filter(!(year <=birthyear & month<=birthmonth)) %>%
filter(!(year >= first_vis_year & month >= first_vis_month))
if(nrow(df_exposure) > n_yrs*MONTHS_PER_YEAR){
df_exposure <- df_exposure[1:(n_yrs*MONTHS_PER_YEAR),]
}
df_exposure[1,]$p_infected <- prob_primary_flu_next_dt(p_uninfected = p_uninfected_init)["p_first_infection"]
df_exposure[1,]$p_naive <-  prob_primary_flu_next_dt(p_uninfected = p_uninfected_init)["p_naive"]
for(y in c(2:nrow(df_exposure))){
df <- prob_primary_flu_next_dt(p_uninfected = unlist(df_exposure[y-1,]$p_naive))
df_exposure[y,]$p_infected <- unlist(df["p_first_infection"])
df_exposure[y,]$p_naive <- unlist(df["p_naive"])
}
df_exposure <- as.data.frame(apply(df_exposure,2,unlist))
df_exposure["h1n1"] = 0
df_exposure["h3n2"] = 0
df_exposure["h2n2"] = 0
for(s in c(1:length(strain_vec))){
strain = strain_vec[s]
for(y in c(1:nrow(df_exposure))){
if(resolution == "month"){
strain_data <- incidence_data %>% filter(year == df_exposure[y,]$year & month == df_exposure[y,]$month)
}
if(resolution == "year"){
strain_data <- incidence_data %>% filter(year == df_exposure[y,]$year)
}
p_inf_this_strain <- as.numeric(strain_data %>% select(contains(strain)))*df_exposure[y,]$p_infected
df_exposure[y,which(names(df_exposure)==strain)] <- p_inf_this_strain
}
}
cum_probs <- apply(df_exposure[, names(df_exposure) %in% strain_vec ],2,sum)
cum_probs
if(nrow(df_exposure) == (n_yrs*MONTHS_PER_YEAR)){
strain_probs <- cum_probs/sum(cum_probs)
strain_probs["p_naive"] <- 0
}
if(nrow(df_exposure) < (n_yrs*MONTHS_PER_YEAR)){
p_naive <- df_exposure[nrow(df_exposure),]$p_naive
strain_probs <- (cum_probs*(1 - p_naive))/sum(cum_probs)
strain_probs["p_naive"] <- p_naive
}
imprinting_data <- lapply(unique(serology$memberID), prob_primary_exposure, demog_data = demography, sero_data = serology)
prob_primary_exposure(id = 4, demog_data = demography, sero_data = serology)
cat("id is ",id, "\n")
demog <- demog_data %>% filter(memberID == id)
sero <- sero_data %>% filter(memberID == id)
first_vis_date <- min(sero$date)
first_vis_month <- month(first_vis_date)
first_vis_year <- year(first_vis_date)
birthdate <- as.Date(demog$birthdate,origin = '1970-1-1') %m+% months(duration_mat_Abs)
birthyear <- year(birthdate)
birthmonth <- month(birthdate)
p_uninfected = p_uninfected_init
df_exposure <- expand.grid(year = c(birthyear:(birthyear + (n_yrs+1))), month = c(1:12)) %>% arrange(year)
df_exposure$p_infected = NA
df_exposure$p_naive = NA
# Make sure that the exposure only starts after birth and that (for kids < 12yo) exposure doesn't overlap visit dates
df_exposure <- df_exposure %>%
filter(!(year <=birthyear & month<=birthmonth)) %>%
filter(!(year >= first_vis_year & month >= first_vis_month))
if(nrow(df_exposure) > n_yrs*MONTHS_PER_YEAR){
df_exposure <- df_exposure[1:(n_yrs*MONTHS_PER_YEAR),]
}
df_exposure[1,]$p_infected <- prob_primary_flu_next_dt(p_uninfected = p_uninfected_init)["p_first_infection"]
df_exposure[1,]$p_naive <-  prob_primary_flu_next_dt(p_uninfected = p_uninfected_init)["p_naive"]
for(y in c(2:nrow(df_exposure))){
df <- prob_primary_flu_next_dt(p_uninfected = unlist(df_exposure[y-1,]$p_naive))
df_exposure[y,]$p_infected <- unlist(df["p_first_infection"])
df_exposure[y,]$p_naive <- unlist(df["p_naive"])
}
df_exposure <- as.data.frame(apply(df_exposure,2,unlist))
df_exposure["h1n1"] = 0
df_exposure["h3n2"] = 0
df_exposure["h2n2"] = 0
for(s in c(1:length(strain_vec))){
strain = strain_vec[s]
for(y in c(1:nrow(df_exposure))){
if(resolution == "month"){
strain_data <- incidence_data %>% filter(year == df_exposure[y,]$year & month == df_exposure[y,]$month)
}
if(resolution == "year"){
strain_data <- incidence_data %>% filter(year == df_exposure[y,]$year)
}
p_inf_this_strain <- as.numeric(strain_data %>% select(contains(strain)))*df_exposure[y,]$p_infected
df_exposure[y,which(names(df_exposure)==strain)] <- p_inf_this_strain
}
}
cum_probs <- apply(df_exposure[, names(df_exposure) %in% strain_vec ],2,sum)
## Scaling
if(nrow(df_exposure) == (n_yrs*MONTHS_PER_YEAR)){
strain_probs <- cum_probs/sum(cum_probs)
strain_probs["p_naive"] <- 0
}
if(nrow(df_exposure) < (n_yrs*MONTHS_PER_YEAR)){
p_naive <- df_exposure[nrow(df_exposure),]$p_naive
strain_probs <- (cum_probs*(1 - p_naive))/sum(cum_probs)
strain_probs["p_naive"] <- p_naive
}
strain_probs
cat("id is ",id, "\n")
demog <- demog_data %>% filter(memberID == id)
sero <- sero_data %>% filter(memberID == id)
first_vis_date <- min(sero$date)
first_vis_month <- month(first_vis_date)
first_vis_year <- year(first_vis_date)
birthdate <- as.Date(demog$birthdate,origin = '1970-1-1') %m+% months(duration_mat_Abs)
birthyear <- year(birthdate)
birthmonth <- month(birthdate)
p_uninfected = p_uninfected_init
df_exposure <- expand.grid(year = c(birthyear:(birthyear + (n_yrs+1))), month = c(1:12)) %>% arrange(year)
df_exposure$p_infected = NA
df_exposure$p_naive = NA
# Make sure that the exposure only starts after birth and that (for kids < 12yo) exposure doesn't overlap visit dates
df_exposure <- df_exposure %>%
filter(!(year <=birthyear & month<=birthmonth)) %>%
filter(!(year >= first_vis_year & month >= first_vis_month))
if(nrow(df_exposure) > n_yrs*MONTHS_PER_YEAR){
df_exposure <- df_exposure[1:(n_yrs*MONTHS_PER_YEAR),]
}
df_exposure[1,]$p_infected <- prob_primary_flu_next_dt(p_uninfected = p_uninfected_init)["p_first_infection"]
df_exposure[1,]$p_naive <-  prob_primary_flu_next_dt(p_uninfected = p_uninfected_init)["p_naive"]
for(y in c(2:nrow(df_exposure))){
df <- prob_primary_flu_next_dt(p_uninfected = unlist(df_exposure[y-1,]$p_naive))
df_exposure[y,]$p_infected <- unlist(df["p_first_infection"])
df_exposure[y,]$p_naive <- unlist(df["p_naive"])
}
df_exposure <- as.data.frame(apply(df_exposure,2,unlist))
df_exposure["h1n1"] = 0
df_exposure["h3n2"] = 0
df_exposure["h2n2"] = 0
for(s in c(1:length(strain_vec))){
strain = strain_vec[s]
for(y in c(1:nrow(df_exposure))){
if(resolution == "month"){
strain_data <- incidence_data %>% filter(year == df_exposure[y,]$year & month == df_exposure[y,]$month)
}
if(resolution == "year"){
strain_data <- incidence_data %>% filter(year == df_exposure[y,]$year)
}
p_inf_this_strain <- as.numeric(strain_data %>% select(contains(strain)))*df_exposure[y,]$p_infected
df_exposure[y,which(names(df_exposure)==strain)] <- p_inf_this_strain
}
}
strain_data <- incidence_data %>% filter(year == df_exposure[y,]$year)
strain_data
p_inf_this_strain <- as.numeric(strain_data %>% select(contains(strain)))*df_exposure[y,]$p_infected
strain_data
head(relative_incidence)
relative_incidence %>% filter(year == 2000)
relative_incidence %>% filter(year == 2001)
GISAID_data = read.csv("../../../Imprinting/frequency_data/GISAID_fractions.csv") %>% select(-X)
head(GISIAID_data)
head(GISAID_data)
GISAID_data = read.csv("../../../Imprinting/frequency_data/GISAID_fractions.csv") %>%
select(-X) %>%
filter(year < 1997)
pandemic_data <- read.csv("../../../Imprinting/frequency_data/Historic_Flu_Pandemics.csv") %>% rename(year = FirstYearOfSeason,
frac_h3n2 = H3N2_fraction,
frac_h1n1 = H1N1_fraction,
frac_h2n2 = H2N2_fraction) %>%
select(-Source) %>%
filter(year < 1968) %>%
arrange(year) %>%
select(year,frac_h1n1,frac_h3n2, frac_h2n2)
pandemic_fractions <- pandemic_data
GISAID_data = read.csv("../../../Imprinting/frequency_data/GISAID_fractions.csv") %>%
select(-X) %>%
filter(year < 1997)
flunet_data = read.csv("../../../Imprinting/frequency_data/FluNetInteractiveReport.csv") %>% mutate(frac_h1n1 = (AH1/INF_A))
flunet_yearly <- flunet_data %>% group_by(Year) %>% summarize(h1 = sum(AH1, AH1N12009, na.rm=T), h3 = sum(AH3,na.rm=T), all_A = sum(INF_A,na.rm=T)) %>%
mutate(frac_h1n1 = h1/all_A, frac_h3n2 = h3/all_A, frac_h2n2 = 0) %>%
rename(year = Year) %>%
select(year, frac_h1n1, frac_h3n2,frac_h2n2) %>%
filter(year %in% c(1997:2012))
relative_incidence <- rbind(pandemic_fractions, GISAID_data,flunet_yearly)
imprinting_data <- lapply(unique(serology$memberID), prob_primary_exposure, demog_data = demography, sero_data = serology)
df_imprinting <- as.data.frame(do.call("rbind",imprinting_data)) %>% mutate(memberID = unique(serology$memberID))
require(MASS)
require(RSQLite)
require(reshape2)
require(dplyr)
source("../Utility_scripts/model_functions.R")
source("../../../Imprinting/imprinting_functions.R")
require(panelPomp)
select <- dplyr::select
rename <- dplyr::rename
summarize <- dplyr::summarise
contains <- dplyr::contains
## Set up input and output files  ## ----------------------------------------------------------------------------------------------------------------------------------
dbFilename <- "../../../Data/Data.sqlite"
test_subtype = "pH1N1"
host_data_filename = paste0("pomp_data_",test_subtype, ".rda")
#Read in data
db <- dbConnect(SQLite(), dbFilename)
serology <- dbReadTable(db, "serology_full_model") %>%
filter(subtype == test_subtype) %>%
mutate(date = as.Date(date, origin = "1970-1-1"))
demography <- dbReadTable(db, "demography_full_model") %>%
mutate(birthdate = as.Date(birthdate, origin = "1970-1-1"),
visitdate = as.Date(visitdate, origin = "1970-1-1"))
L_data <- dbReadTable(db, community_intensity_table_name)
dbDisconnect(db)
#Read in data
db <- dbConnect(SQLite(), dbFilename)
serology <- dbReadTable(db, "serology_full_model") %>%
filter(subtype == test_subtype) %>%
mutate(date = as.Date(date, origin = "1970-1-1"))
demography <- dbReadTable(db, "demography_full_model") %>%
mutate(birthdate = as.Date(birthdate, origin = "1970-1-1"),
visitdate = as.Date(visitdate, origin = "1970-1-1"))
dbDisconnect(db)
calculate_imprinting = T
duration_maternal_Abs = 6 # Months
max_age_first_exposure = 12
MONTHS_PER_YEAR = 12
smooth_frequency_data = F
pandemic_data <- read.csv("../../../Imprinting/frequency_data/Historic_Flu_Pandemics.csv") %>% rename(year = FirstYearOfSeason,
frac_h3n2 = H3N2_fraction,
frac_h1n1 = H1N1_fraction,
frac_h2n2 = H2N2_fraction) %>%
select(-Source) %>%
filter(year < 1968) %>%
arrange(year) %>%
select(year,frac_h1n1,frac_h3n2, frac_h2n2)
pandemic_fractions <- pandemic_data
GISAID_data = read.csv("../../../Imprinting/frequency_data/GISAID_fractions.csv") %>%
select(-X) %>%
filter(year < 1997)
flunet_data = read.csv("../../../Imprinting/frequency_data/FluNetInteractiveReport.csv") %>% mutate(frac_h1n1 = (AH1/INF_A))
flunet_yearly <- flunet_data %>% group_by(Year) %>% summarize(h1 = sum(AH1, AH1N12009, na.rm=T), h3 = sum(AH3,na.rm=T), all_A = sum(INF_A,na.rm=T)) %>%
mutate(frac_h1n1 = h1/all_A, frac_h3n2 = h3/all_A, frac_h2n2 = 0) %>%
rename(year = Year) %>%
select(year, frac_h1n1, frac_h3n2,frac_h2n2) %>%
filter(year %in% c(1997:2012))
relative_incidence <- rbind(pandemic_fractions, GISAID_data,flunet_yearly)
imprinting_data <- lapply(unique(serology$memberID[1:100]), prob_primary_exposure, demog_data = demography, sero_data = serology)
df_imprinting <- as.data.frame(do.call("rbind",imprinting_data)) %>% mutate(memberID = unique(serology$memberID))
head(imprinting_data)
unique(serology$memberID)[6]
id = 15
cat("id is ",id, "\n")
demog <- demog_data %>% filter(memberID == id)
sero <- sero_data %>% filter(memberID == id)
first_vis_date <- min(sero$date)
first_vis_month <- month(first_vis_date)
first_vis_year <- year(first_vis_date)
birthdate <- as.Date(demog$birthdate,origin = '1970-1-1') %m+% months(duration_mat_Abs)
birthyear <- year(birthdate)
birthmonth <- month(birthdate)
demog_data = demography
sero_data = serology
cat("id is ",id, "\n")
demog <- demog_data %>% filter(memberID == id)
sero <- sero_data %>% filter(memberID == id)
first_vis_date <- min(sero$date)
first_vis_month <- month(first_vis_date)
first_vis_year <- year(first_vis_date)
birthdate <- as.Date(demog$birthdate,origin = '1970-1-1') %m+% months(duration_mat_Abs)
birthyear <- year(birthdate)
birthmonth <- month(birthdate)
duration_maternal_Abs = 6 # Months
max_age_first_exposure = 12
MONTHS_PER_YEAR = 12
smooth_frequency_data = F
cat("id is ",id, "\n")
demog <- demog_data %>% filter(memberID == id)
sero <- sero_data %>% filter(memberID == id)
first_vis_date <- min(sero$date)
first_vis_month <- month(first_vis_date)
first_vis_year <- year(first_vis_date)
birthdate <- as.Date(demog$birthdate,origin = '1970-1-1') %m+% months(duration_mat_Abs)
birthyear <- year(birthdate)
birthmonth <- month(birthdate)
duration_mat_Abs = duration_maternal_Abs
demog <- demog_data %>% filter(memberID == id)
sero <- sero_data %>% filter(memberID == id)
first_vis_date <- min(sero$date)
first_vis_month <- month(first_vis_date)
first_vis_year <- year(first_vis_date)
birthdate <- as.Date(demog$birthdate,origin = '1970-1-1') %m+% months(duration_mat_Abs)
birthyear <- year(birthdate)
birthmonth <- month(birthdate)
p_uninfected = p_uninfected_init
df_exposure <- expand.grid(year = c(birthyear:(birthyear + (n_yrs+1))), month = c(1:12)) %>% arrange(year)
n_yrs = 12
p_uninfected_init = 1
demog <- demog_data %>% filter(memberID == id)
sero <- sero_data %>% filter(memberID == id)
first_vis_date <- min(sero$date)
first_vis_month <- month(first_vis_date)
first_vis_year <- year(first_vis_date)
birthdate <- as.Date(demog$birthdate,origin = '1970-1-1') %m+% months(duration_mat_Abs)
birthyear <- year(birthdate)
birthmonth <- month(birthdate)
p_uninfected = p_uninfected_init
df_exposure <- expand.grid(year = c(birthyear:(birthyear + (n_yrs+1))), month = c(1:12)) %>% arrange(year)
df_exposure$p_infected = NA
df_exposure$p_naive = NA
# Make sure that the exposure only starts after birth and that (for kids < 12yo) exposure doesn't overlap visit dates
df_exposure <- df_exposure %>%
filter(!(year <=birthyear & month<=birthmonth)) %>%
filter(!(year >= first_vis_year & month >= first_vis_month))
if(nrow(df_exposure) > n_yrs*MONTHS_PER_YEAR){
df_exposure <- df_exposure[1:(n_yrs*MONTHS_PER_YEAR),]
}
birthyear
tail(df_exposure)
head(df_exposure)
first_vis_year
first_vis_month
df_exposure <- expand.grid(year = c(birthyear:(birthyear + (n_yrs+1))), month = c(1:12)) %>% arrange(year)
df_exposure$p_infected = NA
df_exposure$p_naive = NA
# Make sure that the exposure only starts after birth and that (for kids < 12yo) exposure doesn't overlap visit dates
df_exposure <- df_exposure %>%
filter(!(year <=birthyear & month<=birthmonth)) %>%
filter(!(year >= first_vis_year & month >= first_vis_month) & !(year >= first_vis_year & month <= first_vis_month))
head(df_exposure)
tail(df_exposure)
first_vis_month
df_exposure <- expand.grid(year = c(birthyear:(birthyear + (n_yrs+1))), month = c(1:12)) %>% arrange(year)
df_exposure$p_infected = NA
df_exposure$p_naive = NA
# Make sure that the exposure only starts after birth and that (for kids < 12yo) exposure doesn't overlap visit dates
df_exposure <- df_exposure %>%
filter(!(year <=birthyear & month<=birthmonth)) %>%
filter(!(year >= first_vis_year & month >= first_vis_month) & !(year >= first_vis_year))
head(df_exposure)
tail(df_exposure)
df_exposure <- df_exposure %>%
filter(!(year <=birthyear & month<=birthmonth)) %>%
filter(!(year >= first_vis_year & month >= first_vis_month) & !(year > first_vis_year))
df_exposure <- expand.grid(year = c(birthyear:(birthyear + (n_yrs+1))), month = c(1:12)) %>% arrange(year)
df_exposure$p_infected = NA
df_exposure$p_naive = NA
# Make sure that the exposure only starts after birth and that (for kids < 12yo) exposure doesn't overlap visit dates
df_exposure <- df_exposure %>%
filter(!(year <=birthyear & month<=birthmonth)) %>%
filter(!(year >= first_vis_year & month >= first_vis_month) & !(year > first_vis_year))
head(df_exposure)
tail(df_exposure)
require(ggplot2)
require(MASS)
require(RSQLite)
require(reshape2)
require(dplyr)
source("../Utility_scripts/model_functions.R")
source("../../../Imprinting/imprinting_functions.R")
require(panelPomp)
select <- dplyr::select
rename <- dplyr::rename
summarize <- dplyr::summarise
contains <- dplyr::contains
## Set up input and output files  ## ----------------------------------------------------------------------------------------------------------------------------------
dbFilename <- "../../../Data/Data.sqlite"
test_subtype = "pH1N1"
host_data_filename = paste0("pomp_data_",test_subtype, ".rda")
calculate_imprinting = T
#Read in data
db <- dbConnect(SQLite(), dbFilename)
serology <- dbReadTable(db, "serology_full_model") %>%
filter(subtype == test_subtype) %>%
mutate(date = as.Date(date, origin = "1970-1-1"))
demography <- dbReadTable(db, "demography_full_model") %>%
mutate(birthdate = as.Date(birthdate, origin = "1970-1-1"),
visitdate = as.Date(visitdate, origin = "1970-1-1"))
dbDisconnect(db)
duration_maternal_Abs = 6 # Months
max_age_first_exposure = 12
MONTHS_PER_YEAR = 12
smooth_frequency_data = F
pandemic_data <- read.csv("../../../Imprinting/frequency_data/Historic_Flu_Pandemics.csv") %>% rename(year = FirstYearOfSeason,
frac_h3n2 = H3N2_fraction,
frac_h1n1 = H1N1_fraction,
frac_h2n2 = H2N2_fraction) %>%    select(-Source) %>%
filter(year < 1968) %>%
arrange(year) %>%
select(year,frac_h1n1,frac_h3n2, frac_h2n2)
pandemic_fractions <- pandemic_data
GISAID_data = read.csv("../../../Imprinting/frequency_data/GISAID_fractions.csv") %>%
select(-X) %>%
filter(year < 1997)
flunet_data = read.csv("../../../Imprinting/frequency_data/FluNetInteractiveReport.csv") %>% mutate(frac_h1n1 = (AH1/INF_A))
flunet_yearly <- flunet_data %>% group_by(Year) %>% summarize(h1 = sum(AH1, AH1N12009, na.rm=T), h3 = sum(AH3,na.rm=T), all_A = sum(INF_A,na.rm=T)) %>%
mutate(frac_h1n1 = h1/all_A, frac_h3n2 = h3/all_A, frac_h2n2 = 0) %>%
rename(year = Year) %>%
select(year, frac_h1n1, frac_h3n2,frac_h2n2) %>%
filter(year %in% c(1997:2012))
relative_incidence <- rbind(pandemic_fractions, GISAID_data,flunet_yearly)
imprinting_data <- lapply(unique(serology$memberID)[1:100], prob_primary_exposure, demog_data = demography, sero_data = serology)
df_imprinting <- as.data.frame(do.call("rbind",imprinting_data))
df_imprinting
setwd("~/Desktop/Flu_immune_dynamics/Influenza-immune-dynamics/Models/Single_strain_model/Inference")
